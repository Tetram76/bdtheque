<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.tetram.bdtheque.data.dao.mappers.UniversMapper">
    <resultMap id="UniversLite" type="beanUniversLite">
        <id column="id_univers" property="id"/>
        <result column="nomUnivers" property="nomUnivers"/>
    </resultMap>
    <resultMap id="UniversFull" type="beanUnivers">
        <id column="id_univers" property="id"/>
        <result column="nomUnivers" property="nomUnivers"/>
        <result column="description" property="description"/>
        <result column="siteWeb" property="siteWeb"/>
        <association property="universParent" select="getUniversLiteById" column="id_univers_parent"/>
    </resultMap>

    <select id="getUniversLiteById" resultMap="UniversLite">
        <![CDATA[
        select
            id_univers, nomUnivers
        from
            univers
        where
            id_univers = #{id}
        ]]>
    </select>
    <select id="getUniversById" resultMap="UniversFull">
        <![CDATA[
        select
            id_univers, nomUnivers, id_univers_parent, description, siteWeb
        from
            univers
        where
            id_univers = #{id}
        ]]>
    </select>
    <select id="getListUniversLiteByParaBDId" resultMap="UniversLite">
        <![CDATA[
        select
            u.*
        from
            univers u
            inner join parabd_univers pu on
                pu.id_univers = u.id_univers
        where
            pu.source_parabd = 1 and pu.id_parabd = #{id}
        ]]>
    </select>
    <select id="getListUniversLiteByAlbumId" resultMap="UniversLite">
        <![CDATA[
        select
            u.*
        from
            univers u
            inner join albums_univers au on
                au.id_univers = u.id_univers
        where
            au.source_album = 1 and au.id_album = #{id}
        ]]>
    </select>
    <select id="getListUniversLiteBySerieId" resultMap="UniversLite">
        <![CDATA[
        select
            u.*
        from
            univers u
            inner join series_univers su on
                su.id_univers = u.id_univers
        where
            su.id_serie = #{id}
        ]]>
    </select>

    <select id="checkUniqueUnivers" resultType="UUID">
        <![CDATA[
        select
            id_univers
        from
            univers
        where
            nomUnivers = #{nomUnivers}
        ]]>
        <if test="id != null">
            <![CDATA[
            and id_univers <> #{id}
            ]]>
        </if>
    </select>

    <sql id="saveUnivers">
        <![CDATA[
        update or insert into univers (
            id_univers, nomUnivers, id_univers_parent, description, siteWeb
        ) values (
            #{id}, #{nomUnivers}, #{idUniversParent}, #{description}, #{siteWeb}
        )
        ]]>
    </sql>

    <insert id="createUnivers">
        <selectKey keyProperty="id" order="BEFORE" resultType="UUID">
            <include refid="org.tetram.bdtheque.data.dao.mappers.CommonMapper.autoIncKey"/>
        </selectKey>
        <include refid="saveUnivers"/>
    </insert>

    <update id="updateUnivers">
        <include refid="saveUnivers"/>
    </update>

    <delete id="deleteUnivers">
        <![CDATA[
        delete from univers where id_univers = #{id}
        ]]>
    </delete>

    <update id="cleanUniversAlbum">
        <![CDATA[
        update albums_univers set source_album = 0
        where
            id_album = #{idSerie}
        ]]>
        <if test="univers != null and !univers.isEmpty">
            and id_univers not in
            <foreach collection="univers" item="item" index="index" open="(" separator="," close=")">
                #{item.id}
            </foreach>
        </if>
    </update>
    <insert id="addUniversAlbum">
        <![CDATA[
        update or insert into albums_univers (
            id_album, id_univers, source_album
        ) values (
            #{idAlbum}, #{idUnivers}, 1
        )
        ]]>
    </insert>

    <delete id="cleanUniversSerie">
        <![CDATA[
        delete from series_univers
        where
            id_serie = #{idSerie}
        ]]>
        <if test="univers != null and !univers.isEmpty">
            and id_univers not in
            <foreach collection="univers" item="item" index="index" open="(" separator="," close=")">
                #{item.id}
            </foreach>
        </if>
    </delete>
    <insert id="addUniversSerie">
        <![CDATA[
        update or insert into series_univers (
            id_serie, id_univers
        ) values (
            #{idSerie}, #{idUnivers}
        )
        ]]>
    </insert>

    <update id="cleanUniversParaBD">
        <![CDATA[
         update parabd_univers set source_parabd = 0
        where
            id_parabd = #{idParaBD}
        ]]>
        <if test="univers != null and !univers.isEmpty">
            and id_univers not in
            <foreach collection="univers" item="item" index="index" open="(" separator="," close=")">
                #{item.id}
            </foreach>
        </if>
    </update>
    <insert id="addUniversParaBD">
        <![CDATA[
        update or insert into parabd_univers (
            id_parabd, id_univers, source_parabd
        ) values (
            #{idParaBD}, #{idUnivers}, 1
        )
        ]]>
    </insert>

</mapper>