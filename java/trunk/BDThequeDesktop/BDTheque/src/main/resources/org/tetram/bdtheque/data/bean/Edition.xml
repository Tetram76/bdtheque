<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.tetram.bdtheque.data.mappers.EditionMapper">
    <resultMap id="EditionLite" type="beanEditionLite">
        <id column="id_edition" property="id"/>
        <result column="anneeedition" property="anneeEdition"/>
        <result column="isbn" property="isbn"/>
        <association property="editeur" select="org.tetram.bdtheque.data.mappers.EditeurMapper.getEditeurLiteById"
                     column="id_editeur"/>
        <association property="collection" select="org.tetram.bdtheque.data.mappers.CollectionMapper.getCollectionLiteById"
                     column="id_collection"/>
    </resultMap>
    <resultMap id="EditionFull" type="beanEdition">
        <id column="id_edition" property="id"/>
        <!-- voir pour remplacer par un albumlite -->
        <result column="id_album" property="idAlbum"/>
        <result column="anneeedition" property="anneeEdition"/>
        <result column="prix" property="prix"/>
        <result column="vo" property="vo"/>
        <result column="couleur" property="couleur"/>
        <result column="dedicace" property="dedicace"/>
        <result column="offert" property="offert"/>
        <result column="gratuit" property="gratuit"/>
        <result column="stock" property="stock"/>
        <result column="prete" property="prete"/>
        <result column="isbn" property="isbn"/>
        <result column="typeedition" property="typeEdition"/>
        <result column="etat" property="etat"/>
        <result column="reliure" property="reliure"/>
        <result column="orientation" property="orientation"/>
        <result column="formatedition" property="formatEdition"/>
        <result column="senslecture" property="sensLecture"/>
        <result column="nombredepages" property="nombreDePages"/>
        <result column="dateachat" property="dateAchat"/>
        <result column="notes" property="notes"/>
        <result column="anneecote" property="anneeCote"/>
        <result column="prixcote" property="prixCote"/>
        <result column="numeroperso" property="numeroPerso"/>
        <association property="editeur" select="org.tetram.bdtheque.data.mappers.EditeurMapper.getEditeurById"
                     column="id_editeur"/>
        <association property="collection" select="org.tetram.bdtheque.data.mappers.CollectionMapper.getCollectionById"
                     column="id_collection"/>
        <collection property="couvertures" select="org.tetram.bdtheque.data.mappers.ImageMapper.getListCouvertureLiteByEditionId"
                    column="id_edition"/>
    </resultMap>

    <select id="getEditionLiteById" resultMap="EditionLite">
        <![CDATA[
        select
            id_edition, anneeedition, isbn, id_editeur, id_collection
        from
            editions
        where
            id_edition = #{id}
        ]]>
    </select>

    <sql id="selectEditionFull">
        <![CDATA[
        select
            e.id_edition, e.id_album, e.id_editeur, e.id_collection, e.anneeedition, e.prix, e.vo,
            e.couleur, e.isbn, e.dedicace, e.prete, e.stock, e.offert, e.gratuit, e.nombredepages, e.dateachat, e.notes,
            e.anneecote, e.prixcote, e.numeroperso,
            e.etat, le.libelle as lb_etat,
            e.reliure, lr.libelle as lb_reliure,
            e.orientation, lo.libelle as lb_orientation,
            e.formatedition, lf.libelle as lb_formatedition,
            e.typeedition, lte.libelle as lb_typeedition,
            e.senslecture, lsl.libelle as lb_senslecture
        from
            editions e
            left join listes le on
                (le.ref = e.etat and le.categorie = 1)
            left join listes lr on
                (lr.ref = e.reliure and lr.categorie = 2)
            left join listes lte on
                (lte.ref = e.typeedition and lte.categorie = 3)
            left join listes lo on
                (lo.ref = e.orientation and lo.categorie = 4)
            left join listes lf on
                (lf.ref = e.formatedition and lf.categorie = 5)
            left join listes lsl on
                (lsl.ref = e.senslecture and lsl.categorie = 8)
        ]]>
    </sql>

    <select id="getEditionById" parameterType="UUID" resultMap="EditionFull">
        <include refid="selectEditionFull"/>
        <where>
            e.id_edition = #{id}
        </where>
    </select>
    <select id="getListEditionByAlbumId" resultMap="EditionFull" >
        <include refid="selectEditionFull"/>
        <where>
            e.id_album = #{id}
            <if test="stock != null">
            and e.stock = #{stock}
            </if>
        </where>
    </select>
</mapper>