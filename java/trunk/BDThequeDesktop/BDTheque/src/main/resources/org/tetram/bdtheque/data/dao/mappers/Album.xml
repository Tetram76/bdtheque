<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.tetram.bdtheque.data.dao.mappers.AlbumMapper">
    <resultMap id="AlbumLite" type="beanAlbumLite">
        <id column="id_album" property="id"/>
        <result column="titreAlbum" property="titre"/>
        <result column="tome" property="tome"/>
        <result column="TomeDebut" property="tomeDebut"/>
        <result column="TomeFin" property="tomeFin"/>
        <result column="id_serie" property="idSerie"/>
        <result column="integrale" property="integrale"/>
        <result column="HorsSerie" property="horsSerie"/>
        <result column="id_editeur" property="idEditeur"/>
        <result column="TitreSerie" property="serie"/>
        <result column="NomEditeur" property="editeur"/>
        <result column="MoisParution" property="moisParution"/>
        <result column="AnneeParution" property="anneeParution"/>
        <result column="stock" property="stock"/>
        <result column="achat" property="achat"/>
        <result column="complet" property="complet"/>
        <result column="notation" property="notation"/>
    </resultMap>
    <resultMap id="AlbumFull" type="beanAlbum">
        <id column="id_album" property="id"/>
        <result column="TitreAlbum" property="titreAlbum"/>
        <result column="AnneeParution" property="anneeParution"/>
        <result column="MoisParution" property="moisParution"/>
        <result column="SujetAlbum" property="sujet"/>
        <result column="RemarquesAlbum" property="notes"/>
        <result column="tome" property="tome"/>
        <result column="TomeDebut" property="tomeDebut"/>
        <result column="TomeFin" property="tomeFin"/>
        <result column="integrale" property="integrale"/>
        <result column="HorsSerie" property="horsSerie"/>
        <result column="notation" property="notation"/>
        <result column="complet" property="complet"/>
        <association property="serie" select="org.tetram.bdtheque.data.dao.mappers.SerieMapper.getSerieById"
                     column="id_serie"/>
        <collection property="univers"
                    select="org.tetram.bdtheque.data.dao.mappers.UniversMapper.getListUniversLiteByAlbumId"
                    column="id_album" fetchType="eager"/>
        <collection property="editions"
                    select="org.tetram.bdtheque.data.dao.mappers.EditionMapper.getListEditionByAlbumId"
                    column="{id=id_album}"/>
        <collection property="auteurs"
                    select="org.tetram.bdtheque.data.dao.mappers.AuteurMapper.getListAuteurLiteByAlbumId"
                    column="id_album" fetchType="eager"/>
    </resultMap>

    <sql id="fieldsAlbumLite">
        a.id_album, a.titreAlbum, a.horsSerie, a.integrale, a.tome, a.tomeDebut, a.tomeFin, a.id_serie, a.achat,
        a.complet
    </sql>
    <sql id="orderAlbum">
        a.horsSerie nulls first, a.integrale nulls first, a.tome nulls first, a.anneeParution, a.moisParution
    </sql>

    <select id="getAlbumLiteById" resultMap="AlbumLite">
        select
        <include refid="fieldsAlbumLite"/>
        , a.titreSerie
        <if test="idEdition != null">
            , e.stock
        </if>
        <![CDATA[
        from
            vw_liste_albums a
        ]]>
        <if test="idEdition != null">
            <![CDATA[
            inner join editions e on
                a.id_album = e.id_album
            ]]>
        </if>
        <![CDATA[
        where
            a.id_album = #{id}
        ]]>
        <if test="idEdition != null">
            <![CDATA[
            and e.id_edition = #{idEdition}
            ]]>
        </if>
    </select>
    <select id="getAlbumById" parameterType="UUID" resultMap="AlbumFull">
        <![CDATA[
        select
            a.id_album, a.titreAlbum, a.moisParution, a.anneeParution, a.id_serie, a.tome, a.tomeDebut, a.tomeFin, a.sujetAlbum,
            a.remarquesAlbum, a.horsSerie, a.integrale, a.complet, a.notation, n.libelle as lb_notation
        from
            albums a
            left join listes n on
                (n.ref = a.notation and n.categorie = 9)
        where
            a.id_album = #{id}
        ]]>
    </select>
    <select id="getListAlbumLiteBySerieIdByAuteurId" parameterType="map" resultMap="AlbumLite" resultOrdered="true">
        select
        <include refid="fieldsAlbumLite"/>
        <![CDATA[
          , a.notation, n.libelle as lb_notation
        from
            albums a
            left join listes n on
                (n.ref = a.notation and n.categorie = 9)
        ]]>
        <where>
            <choose>
                <when test="idSerie == null">
                    (a.id_serie is null or a.id_serie = #{idSerie})
                </when>
                <otherwise>
                    a.id_serie = #{idSerie}
                </otherwise>
            </choose>
            <if test="idAuteur != null">
                and a.id_album in (select id_album from auteurs where id_personne = #{idAuteur})
            </if>
        </where>
        order by
        <include refid="orderAlbum"/>
    </select>

    <select id="getInitiales" resultMap="org.tetram.bdtheque.data.dao.mappers.CommonMapper.InitialeEntityCharacter">
        <![CDATA[
        select
            initialeTitreAlbum "label", countInitiale "count", initialeTitreAlbum "value"
        from
            initiales_albums(#{filtre})
        ]]>
    </select>

    <select id="getAlbumLiteByInitiale" resultMap="AlbumLite">
        select
        <include refid="fieldsAlbumLite"/>, a.titreSerie, a.notation
        <![CDATA[
        from
            albums_by_initiale(#{initiale}, #{filtre}) a
        ]]>
    </select>

    <select id="getInitialesSeries" resultMap="org.tetram.bdtheque.data.dao.mappers.CommonMapper.InitialeEntityUUID">
        <![CDATA[
        select
            titreSerie "label", countSerie "count", id_serie "value"
        from
            series_albums(#{filtre})
        ]]>
    </select>

    <select id="getListAlbumLiteBySerie" resultMap="AlbumLite">
        <if test="idSerie == null">
            <bind name="idSerie" value="''"/>
        </if>
        select
        <include refid="fieldsAlbumLite"/>, a.titreSerie, a.notation
        <![CDATA[
        from
            albums_by_serie(#{idSerie}, #{filtre}) a
        ]]>
    </select>

    <select id="getInitialesCollections"
            resultMap="org.tetram.bdtheque.data.dao.mappers.CommonMapper.InitialeEntityUUID">
        <![CDATA[
        select
            nomCollection "label", countCollection "count", id_collection "value"
        from
            collections_albums(#{filtre})
        ]]>
    </select>

    <select id="getAlbumLiteByCollection" resultMap="AlbumLite">
        <if test="idCollection == null">
            <bind name="idCollection" value="''"/>
        </if>
        select
        <include refid="fieldsAlbumLite"/>, a.titreSerie, a.notation
        <![CDATA[
        from
            albums_by_collection(#{idCollection}, #{filtre}) a
        ]]>
    </select>

    <select id="getInitialesEditeurs" resultMap="org.tetram.bdtheque.data.dao.mappers.CommonMapper.InitialeEntityUUID">
        <![CDATA[
        select
            nomEditeur "label", countEditeur "count", id_editeur "value"
        from
            editeurs_albums(#{filtre})
        ]]>
    </select>

    <select id="getAlbumLiteByEditeur" resultMap="AlbumLite">
        <if test="idEditeur == null">
            <bind name="idEditeur" value="''"/>
        </if>
        select
        <include refid="fieldsAlbumLite"/>, a.titreSerie, a.notation
        <![CDATA[
        from
            albums_by_editeur(#{idEditeur}, #{filtre}) a
        ]]>
    </select>

    <select id="getInitialesGenres" resultMap="org.tetram.bdtheque.data.dao.mappers.CommonMapper.InitialeEntityUUID">
        <![CDATA[
        select
            genre "label", countGenre "count", id_genre "value"
        from
            genres_albums(#{filtre})
        ]]>
    </select>

    <select id="getAlbumLiteByGenre" resultMap="AlbumLite">
        <if test="idGenre == null">
            <bind name="idGenre" value="''"/>
        </if>
        select
        <include refid="fieldsAlbumLite"/>, a.titreSerie, a.notation
        <![CDATA[
        from
            albums_by_genre(#{idGenre}, #{filtre}) a
        ]]>
    </select>

    <select id="getInitialesAnnees" resultMap="org.tetram.bdtheque.data.dao.mappers.CommonMapper.InitialeEntityYear">
        <![CDATA[
        select
            anneeParution "label", countAnnee "count", nullif(anneeParution, -1) "value"
        from
            annees_albums(#{filtre})
        ]]>
    </select>

    <select id="getAlbumLiteByAnnee" resultMap="AlbumLite">
        <if test="annee == null">
            <bind name="annee" value="-1"/>
        </if>
        select
        <include refid="fieldsAlbumLite"/>, a.titreSerie, a.notation
        <![CDATA[
        from
            albums_by_annee(#{annee}, #{filtre}) a
        ]]>
    </select>

    <update id="changeNotation">
        <![CDATA[
        update albums set notation = #{notation} where id_album = #{id}
        ]]>
    </update>
    <update id="acheter">
        <![CDATA[
        update albums set achat = #{achat} where id_album = #{id}
        ]]>
    </update>

    <sql id="saveAlbum">
        <![CDATA[
        update or insert into albums (
            id_album, titreAlbum, moisParution, anneeParution, id_serie, tome, tomeDebut, tomeFin,
            horsSerie, integrale, sujetAlbum, remarquesAlbum
        ) values (
            #{id}, #{titreAlbum}, #{moisParution}, #{anneeParution}, #{idSerie}, #{tome}, #{tomeDebut}, #{tomeFin},
            #{horsSerie}, #{integrale}, #{sujet}, #{notes}
        )
        ]]>
    </sql>

    <insert id="createAlbum">
        <selectKey keyProperty="id" order="BEFORE" resultType="UUID">
            <include refid="org.tetram.bdtheque.data.dao.mappers.CommonMapper.autoIncKey"/>
        </selectKey>
        <include refid="saveAlbum"/>
    </insert>

    <update id="updateAlbum">
        <include refid="saveAlbum"/>
    </update>

    <delete id="deleteAlbum">
        <![CDATA[
        delete from albums where id_album = #{id}
        ]]>
    </delete>

</mapper>

